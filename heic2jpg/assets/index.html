<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"> 
    <title>HEIC to JPEG</title>   
	<script src="libheif.js"></script>
    <style>
.flex-container {
  display: flex;
  justify-content: center;
}

.flex-container > div {
  width: 100px;
  margin: 10px;
  text-align: center;
  line-height: 75px;
  font-size: 30px;
}
.icon {
    width: 100%;
    height: 100%;
}
.icon-small {
    width: 50%;
    height: 100%;
}
.icon-done {
    filter: invert(48%) sepia(79%) saturate(2476%) hue-rotate(86deg) brightness(118%) contrast(119%);
}
.icon-error {
	filter: invert(13%) sepia(96%) saturate(6088%) hue-rotate(358deg) brightness(92%) contrast(119%);
}
/* https://stackoverflow.com/a/20217870 */
.imageRotateHorizontal{
    -moz-animation: spinHorizontal .8s infinite linear;
    -o-animation: spinHorizontal .8s infinite linear;    
    -webkit-animation: spinHorizontal .8s infinite linear;
    animation: spinHorizontal .8s infinite linear;
}

@-moz-keyframes spinHorizontal {
    0% {
        -moz-transform: rotateY(0deg);
    }

    100% {
        -moz-transform: rotateY(360deg);
    }
}

@keyframes spinHorizontal {
	0% { 
        transform: rotateY(0deg); 
	}
    100% {
        transform: rotateY(360deg);
    }
}


@-ms-keyframes spinHorizontal {
	0% { 
        -ms-transform: rotateY(0deg); 
	}
    100% {
        -ms-transform: rotateY(360deg);
    }
}

@-o-keyframes spinHorizontal {
	0% { 
        -o-transform: rotateY(0deg); 
	}
	100% { 
        -o-transform: rotateY(360deg); 
	}
}

@-webkit-keyframes spinHorizontal {
	0% { 
        -webkit-transform: rotateY(0deg); 
	}
	100% { 
        -webkit-transform: rotateY(360deg); 
	}
}
    </style>
  </head>
  <body onload='onload();'>
  	<h1 style="text-align:center;">HEIC to JPEG</h1>
  	<div>
  		<p style="text-align:center;">
  			HEIF and AVIF are new image file formats
		</p>  	
  		<p style="text-align:center;">
  			libheif is used to decode the image file. The output is a JPEG file (compression: 0.8)
		</p>  	 		  	 	
  	</div>
  	<div style="margin-left: 20%;">
  	  	<h3>File:&nbsp;<span id='filename'></span></h3>
  	</div>
	<div class="flex-container">
  		<div>
  			<img id="readFileIcon" src="file-image-o.svg" class="icon">
  		</div>
  		<div>
	  		<img src="arrow-circle-o-right.svg" class="icon-small">  		
  		</div>
  		<div>
	  		<img id="convertFileIcon" src="gears.svg" class="icon">  		
  		</div>  
  		<div>
	  		<img src="arrow-circle-o-right.svg" class="icon-small">  		
  		</div>
  		<div>
	  		<img id="writeFileIcon" src="photo.svg" class="icon">
  		</div>  
	</div>
  	<p id='status' style="text-align:center;"></p>
  	<div id='messages'></div>
	<script>
    
	function onload() {
		let href = window.location.href
		let url = new URL(href);
		let filePath = url.searchParams.get("path");
		let filename = filePath.substring(filePath.lastIndexOf('/') + 1);
		let isPathWritable = url.searchParams.get("isPathWritable") == 'true';
		document.getElementById("filename").innerText = filename;
		if (!isPathWritable) {
			document.getElementById("status").innerText = 'File access is read only';		
		} else {
			document.getElementById("status").innerText = 'loading file...';
			fetch(filePath, { method: 'GET' }).then(function(response) {				
    	  		if (response.status === 200) {  
    	  			document.getElementById('readFileIcon').classList.add("icon-done");
					response.arrayBuffer().then(function(bytes) {
						document.getElementById("status").innerText = 'converting document...';
						document.getElementById("convertFileIcon").classList.add("imageRotateHorizontal");
						if(bytes.byteLength > 0){
        					fetch('libheif.wasm')
            					.then((res) => res.arrayBuffer()).then((wasmBinary) => {
            						try {
                						var lib = libheif({ wasmBinary: wasmBinary });
					    				const decoder = new lib.HeifDecoder();
        								const image = decoder.decode(new Uint8Array(bytes).buffer)[0];
    									var canvas = document.createElement('canvas');
    									var ctx = canvas.getContext('2d', { willReadFrequently: true });
							        	var w = image.get_width();
        								var h = image.get_height();
            							canvas.width = w;
            							canvas.height = h;
            							var image_data = ctx.createImageData(w, h);
            							var pixels = image_data.data;
            							for (var i = 0; i< w * h; i++) {
                							pixels[ i * 4 + 3] = 255;
            							}
        								image.display(image_data, function(display_image_data) {
            								ctx.putImageData(display_image_data, 0, 0);
            								let dataUrl = canvas.toDataURL("image/jpeg",0.8);
            								save(filename, dataUrl);
        								});
        							} catch (error) {
        								document.getElementById("convertFileIcon").classList.remove("imageRotateHorizontal");
										document.getElementById('convertFileIcon').classList.add("icon-error");
										document.getElementById("status").innerText = 'unable to convert document';
      									console.log('unable to convert file:' + error);
        							}
                				});						    	    
        				} else {
        	            	document.getElementById("convertFileIcon").classList.remove("imageRotateHorizontal");
        	            	document.getElementById('convertFileIcon').classList.add("icon-error");
							document.getElementById("status").innerText = 'unable to convert file';
					    }
		    	    });					
              	} else {
    	  			document.getElementById('readFileIcon').classList.add("icon-error");              	
					document.getElementById("status").innerText = 'unable to load file';
      				console.log('error loading file:' + response.status);
      			}
			});
		}
    }
    function save(originalFilename, dataUrl) {
        	document.getElementById("convertFileIcon").classList.remove("imageRotateHorizontal");
    		document.getElementById('convertFileIcon').classList.add("icon-done");
			document.getElementById("status").innerText = 'saving file...';     
			let binaryData = window.atob(dataUrl.substring("data:image/jpeg;base64,".length));
            var ta = new Int8Array(binaryData.length);
            for (var i = 0; i < binaryData.length; i++) {
                ta[i] = binaryData.charCodeAt(i);
            }
    	    let withoutExtension = originalFilename.substring(0, originalFilename.lastIndexOf('.'));
    		let newFilename = withoutExtension + '.jpg';
    		let fullPath = '/peergos-api/v0/save/' + newFilename;
  			fetch(fullPath, { method: 'PUT', headers: {}, body: ta })
    			.then(function(response) {
          			if (response.status != 200) {
						document.getElementById('writeFileIcon').classList.add("icon-error");
						document.getElementById("status").innerText = 'unable to save file';
      					console.log('unable to save converted file:' + response.status);
      				} else {
						document.getElementById('writeFileIcon').classList.add("icon-done");
						document.getElementById("status").innerText = 'file saved';   	      				
      				}
    		}); 	 	
    }
    </script>
  </body>
</html>

