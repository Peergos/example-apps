<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"> 
    <title>Luckysheet 2 Excel</title>   
    <link rel='stylesheet' href='luckysheet-style.css' />
	<script src="plugin.js"></script>
	<script src="luckysheet.umd.js"></script>
	<script src="luckyexcel.umd.js"></script>
    <style>
    .flex-container {
  display: flex;
  justify-content: center;
}

.flex-container > div {
  width: 100px;
  margin: 10px;
  text-align: center;
  line-height: 75px;
  font-size: 30px;
}
.icon {
    width: 100%;
    height: 100%;
}
.icon-small {
    width: 50%;
    height: 100%;
}
.icon-done {
    filter: invert(48%) sepia(79%) saturate(2476%) hue-rotate(86deg) brightness(118%) contrast(119%);
}
.icon-error {
	filter: invert(13%) sepia(96%) saturate(6088%) hue-rotate(358deg) brightness(92%) contrast(119%);
}
/* https://stackoverflow.com/a/20217870 */
.imageRotateHorizontal{
    -moz-animation: spinHorizontal .8s infinite linear;
    -o-animation: spinHorizontal .8s infinite linear;    
    -webkit-animation: spinHorizontal .8s infinite linear;
    animation: spinHorizontal .8s infinite linear;
}

@-moz-keyframes spinHorizontal {
    0% {
        -moz-transform: rotateY(0deg);
    }

    100% {
        -moz-transform: rotateY(360deg);
    }
}

@keyframes spinHorizontal {
	0% { 
        transform: rotateY(0deg); 
	}
    100% {
        transform: rotateY(360deg);
    }
}


@-ms-keyframes spinHorizontal {
	0% { 
        -ms-transform: rotateY(0deg); 
	}
    100% {
        -ms-transform: rotateY(360deg);
    }
}

@-o-keyframes spinHorizontal {
	0% { 
        -o-transform: rotateY(0deg); 
	}
	100% { 
        -o-transform: rotateY(360deg); 
	}
}

@-webkit-keyframes spinHorizontal {
	0% { 
        -webkit-transform: rotateY(0deg); 
	}
	100% { 
        -webkit-transform: rotateY(360deg); 
	}
}
    </style>
  </head>
  <body onload='onload();'>
  	<h1 style="text-align:center;">Luckysheet 2 Excel</h1>
  	<div id="luckysheet" style="display: none"></div>
  	<div>
  		<p style="text-align:center;">
  			Luckysheet 2 Excel converts a LuckySheet (.sheet) file to a Microsoft Excel (.xlsx) spreadsheet.
		</p>  	
  		<p style="text-align:center;">
  			It is very experimental and not supported. Note: Images and graphs are not preserved.
		</p>  	 		  	 	
  	</div>
  	<div style="margin-left: 20%;">
  	  	<h3>File:&nbsp;<span id='filename'></span></h3>
  	</div>
	<div class="flex-container">
  		<div>
  			<img id="readFileIcon" src="file-luckysheet.png" class="icon">
  		</div>
  		<div>
	  		<img src="arrow-circle-o-right.svg" class="icon-small">  		
  		</div>
  		<div>
	  		<img id="convertFileIcon" src="gears.svg" class="icon">  		
  		</div>  
  		<div>
	  		<img src="arrow-circle-o-right.svg" class="icon-small">  		
  		</div>
  		<div>
	  		<img id="writeFileIcon" src="file-excel-o.svg" class="icon">
  		</div>  
	</div>
  	<p id='status' style="text-align:center;"></p>
  	<div id='messages'></div>
	<script>
    
	function onload() {
		let href = window.location.href
		let url = new URL(href);
		let filePath = url.searchParams.get("path");
		let filename = filePath.substring(filePath.lastIndexOf('/') + 1);
		let isPathWritable = url.searchParams.get("isPathWritable") == 'true';
		let options = {
            container: 'luckysheet', //luckysheet is the container id
            	userMenuItem: [],
  				myFolderUrl: "",
  				lang: 'en',
  				title: '', //filename, todo - can't use as import will change filename (maybe can get from resp on save call?)
        };
		document.getElementById("filename").innerText = filename;
		if (!isPathWritable) {
			document.getElementById("status").innerText = 'File access is read only';		
		} else {
			document.getElementById("status").innerText = 'loading file...';
			fetch(filePath, { method: 'GET' }).then(function(response) {				
    	  		if (response.status === 200) {  
    	  			document.getElementById('readFileIcon').classList.add("icon-done");
					response.arrayBuffer().then(function(bytes) {
						document.getElementById("status").innerText = 'converting document...';
						document.getElementById("convertFileIcon").classList.add("imageRotateHorizontal");
						if(bytes.byteLength > 0){
        					let text = new TextDecoder().decode(bytes);
        					let json = JSON.parse(text);
        					options.data = json;
	        				luckysheet.create(options);
	        				save(filename);
        				} else {
        	            	document.getElementById("convertFileIcon").classList.remove("imageRotateHorizontal");
        	            	document.getElementById('convertFileIcon').classList.add("icon-error");
							document.getElementById("status").innerText = 'unable to convert document';
					    }
		    	    });					
              	} else {
    	  			document.getElementById('readFileIcon').classList.add("icon-error");              	
					document.getElementById("status").innerText = 'unable to load file';
      				console.log('error loading file:' + response.status);
      			}
			});
		}
    }
    function save(originalFilename) {
        const json = window.luckysheet.toJson();
        //LuckyExcel.transformLuckyToExcel(json, (data) => { //this export method is not as accurate as using exportjs method
        LuckyExcel.transformLuckyToExceljs(json, (data) => { 
        	document.getElementById("convertFileIcon").classList.remove("imageRotateHorizontal");
    		document.getElementById('convertFileIcon').classList.add("icon-done");
			document.getElementById("status").innerText = 'saving file...';     
    		//let bytes = window.exportFile;
    		let bytes = window.exportExcelJsFile;
    	    let withoutExtension = originalFilename.substring(0, originalFilename.lastIndexOf('.'));
    		let sheetFilename = withoutExtension + '.xlsx';
    		let fullPath = '/peergos-api/v0/save/' + sheetFilename;
  			fetch(fullPath, { method: 'PUT', headers: {}, body: bytes })
    			.then(function(response) {
          			if (response.status != 200) {
						document.getElementById('writeFileIcon').classList.add("icon-error");
						document.getElementById("status").innerText = 'unable to save file';
      					console.log('unable to save converted file:' + response.status);
      				} else {
						document.getElementById('writeFileIcon').classList.add("icon-done");
						document.getElementById("status").innerText = 'file saved';   	      				
      				}
    		}); 	 	
        }, error => {
        	document.getElementById("convertFileIcon").classList.remove("imageRotateHorizontal");
			document.getElementById('convertFileIcon').classList.add("icon-error");
			document.getElementById("status").innerText = 'unable to convert document';
      		console.log('unable to convert file:' + error);
        });
    }
    </script>
  </body>
</html>

